---
title: "Youtu-GraphRAG æºç ï¼šAgentic åˆ†è§£ä¸ IRCoT è¿­ä»£æ¨ç†"
showAuthor: false
date: 2025-12-26
description: ""
slug: "youtu-graphrag-code-5"
tags: ["GraphRAG"]
series: ["Youtu-GraphRAG"]
series_order: 6
draft: false
---

<!-- æ¸²æŸ“å…¬å¼ -->
{{< katex >}}



{{< alert "github" >}}
[TencentCloudADP/Youtu-GraphRAG](https://github.com/TencentCloudADP/youtu-graphrag.git)
{{< /alert >}}


<!-- <figure>
  <img src="" alt="">
  <figcaption style="text-align: center;"></figcaption>
</figure> -->


<!-- # Youtu-GraphRAG æºç æ·±åº¦è§£è¯» (5)ï¼šAgentic åˆ†è§£ä¸ IRCoT è¿­ä»£æ¨ç† -->

## 1. å¼•è¨€

åœ¨ RAG ç³»ç»Ÿä¸­ï¼Œé¢å¯¹â€œè°æ˜¯ç”µå½±ã€ŠXã€‹å¯¼æ¼”çš„çˆ¶äº²ï¼Ÿâ€è¿™ç±»å¤šè·³é—®é¢˜ï¼ˆMulti-hop Questionï¼‰ï¼Œç®€å•çš„å‘é‡æ£€ç´¢å¾€å¾€å¤±æ•ˆï¼Œå› ä¸ºå‘é‡ç©ºé—´éš¾ä»¥æ•æ‰å¤šé‡å…³ç³»çš„é€»è¾‘é“¾è·¯ã€‚

`youtu-graphrag` å¼•å…¥äº† **Agentic RAG** çš„èŒƒå¼æ¥è§£å†³è¿™ä¸€éš¾é¢˜ã€‚å®ƒä¸å†è¯•å›¾ä¸€æ¬¡æ€§æ£€ç´¢å‡ºæ‰€æœ‰ç­”æ¡ˆï¼Œè€Œæ˜¯æ¨¡ä»¿äººç±»ä¸“å®¶çš„è§£é¢˜æ€è·¯ï¼šå…ˆå°†å¤§é—®é¢˜æ‹†è§£ä¸ºå°é—®é¢˜ï¼Œç„¶åé€šè¿‡â€œæ£€ç´¢-æ€è€ƒ-å†æ£€ç´¢â€çš„å¾ªç¯é€æ­¥é€¼è¿‘ç­”æ¡ˆã€‚è¿™ä¸€è¿‡ç¨‹è¢«ç§°ä¸º **IRCoT (Iterative Retrieval Chain of Thought)**ã€‚

## 2. æˆ˜ç•¥å±‚ï¼šGraphQ é—®é¢˜åˆ†è§£å™¨

æ¨ç†çš„ç¬¬ä¸€æ­¥å¹¶éç›´æ¥æ£€ç´¢ï¼Œè€Œæ˜¯é™ç»´ã€‚`GraphQ` æ¨¡å—è´Ÿè´£åˆ©ç”¨å›¾ Schema å°†å¤æ‚çš„è‡ªç„¶è¯­è¨€é—®é¢˜è½¬åŒ–ä¸ºâ€œå›¾å¯è§£â€çš„åŸå­å­é—®é¢˜ã€‚

### 2.1 Schema æ„ŸçŸ¥çš„åˆ†è§£ (Schema-Aware Decomposition)
åœ¨ `models/retriever/agentic_decomposer.py` ä¸­ï¼Œ`decompose` æ–¹æ³•è°ƒç”¨ LLM è¿›è¡Œæ‹†è§£ã€‚ä¸æ™®é€šåˆ†è§£ä¸åŒï¼ŒPrompt ä¸­æ˜¾å¼æ³¨å…¥äº†å›¾çš„ Ontologyï¼ˆæœ¬ä½“è®º/Schemaï¼‰ã€‚

```python
# Prompt æ ¸å¿ƒæŒ‡ä»¤ (config/base_config.yaml)
"""
Given the following ontology and the question, decompose the complex question...
CRITICAL REQUIREMENTS:
1. Each sub-question must be... Explicitly reference entities and relations...
2. Identify all schema types that might be involved
"""
```

è¿™ç§è®¾è®¡è¿«ä½¿ LLM åœ¨åˆ†è§£æ—¶â€œæˆ´ç€é•£é“è·³èˆâ€ï¼Œç¡®ä¿ç”Ÿæˆçš„å­é—®é¢˜ä¸­çš„æœ¯è¯­ï¼ˆå¦‚å…³ç³»è°“è¯ï¼‰å°½å¯èƒ½ä¸å›¾è°±ä¸­çš„å®šä¹‰å¯¹é½ï¼Œä»è€Œæé«˜åç»­æ£€ç´¢çš„å‘½ä¸­ç‡ã€‚

### 2.2 ç±»å‹é¢„åˆ¤ä¸æœç´¢ç©ºé—´å‰ªæ
`GraphQ` çš„å¦ä¸€ä¸ªé‡è¦äº§å‡ºæ˜¯ `involved_types`ã€‚LLM ä¼šé¢„æµ‹å›ç­”è¯¥é—®é¢˜å¯èƒ½æ¶‰åŠçš„èŠ‚ç‚¹ç±»å‹ï¼ˆå¦‚ `person`ï¼‰ã€å…³ç³»ç±»å‹ï¼ˆå¦‚ `directed_by`ï¼‰å’Œå±æ€§ã€‚

åœ¨åç»­çš„ `KTRetriever` æ£€ç´¢ä¸­ï¼Œè¿™äº›ç±»å‹ä¿¡æ¯å……å½“äº†**é¢„è¿‡æ»¤å™¨**ã€‚å¦‚æœ LLM é¢„æµ‹åªæ¶‰åŠâ€œäººç‰©â€å’Œâ€œç”µå½±â€ï¼Œæ£€ç´¢å™¨å°±å¯ä»¥ç›´æ¥å¿½ç•¥â€œåœ°ç‚¹â€æˆ–â€œç»„ç»‡â€ç±»å‹çš„èŠ‚ç‚¹ã€‚è¿™ç§æœºåˆ¶åœ¨æ•°ç™¾ä¸‡èŠ‚ç‚¹çš„å¤§è§„æ¨¡å›¾è°±ä¸­ï¼Œå¯¹äºé™ä½æ£€ç´¢å™ªå£°ã€æå‡ä¿¡å™ªæ¯”å…·æœ‰é‡è¦çš„å·¥ç¨‹ä»·å€¼ã€‚

## 3. æ‰§è¡Œå±‚ï¼šMap-Reduce å¹¶è¡Œæ£€ç´¢

åˆ†è§£å¾—åˆ°çš„å­é—®é¢˜ï¼ˆ`sub_questions`ï¼‰é€šå¸¸æ˜¯ç›¸äº’ç‹¬ç«‹çš„ç®€å•äº‹å®æŸ¥è¯¢ã€‚`main.py` ä¸­çš„ `initial_question_decomposition` å®ç°äº†ç±»ä¼¼ Map-Reduce çš„å¤„ç†é€»è¾‘ï¼š

1.  **Map (å¹¶è¡Œæ‰§è¡Œ):** ç³»ç»Ÿæ£€æµ‹åˆ°å¤šä¸ªå­é—®é¢˜åï¼Œä¼šè°ƒç”¨ `kt_retriever.process_subquestions_parallel`ã€‚è¿™åˆ©ç”¨äº† Python çš„ `ThreadPoolExecutor` å¹¶å‘åœ°å¯¹æ¯ä¸ªå­é—®é¢˜æ‰§è¡Œæ£€ç´¢ã€‚
2.  **Reduce (ç»“æœèšåˆ):** æ‰€æœ‰å­é—®é¢˜çš„æ£€ç´¢ç»“æœï¼ˆä¸‰å…ƒç»„å’Œæ–‡æœ¬å—ï¼‰è¢«æ±‡æ€»åˆ°ä¸€ä¸ªé›†åˆä¸­ã€‚

```python
# main.py

if len(sub_questions) > 1:
    logger.info("ğŸš€ Using parallel sub-question processing...")
    aggregated_results, _ = kt_retriever.process_subquestions_parallel(...)
    all_triples.update(aggregated_results['triples'])
```

è¿™ä¸€è®¾è®¡æ˜¾è‘—é™ä½äº†é¦–è½®æ£€ç´¢çš„å»¶è¿Ÿã€‚ç„¶è€Œï¼Œå¹¶è¡Œåº¦å—é™äº LLM API çš„é€Ÿç‡é™åˆ¶ï¼ˆRate Limitï¼‰å’Œ Embedding æ¨¡å‹çš„å¹¶å‘ååèƒ½åŠ›ï¼Œåœ¨å®é™…éƒ¨ç½²æ—¶é€šå¸¸éœ€è¦é…ç½® token æ¡¶ç­‰é™æµæœºåˆ¶ã€‚

## 4. æ ¸å¿ƒå¤§è„‘ï¼šIRCoT è¿­ä»£æ¨ç†å¾ªç¯

å¯¹äºé€»è¾‘ä¾èµ–æ€§å¼ºçš„é—®é¢˜ï¼ˆä¾‹å¦‚ï¼šå…ˆæŸ¥å‡ºAæ˜¯è°ï¼Œå†æŸ¥Aåšäº†ä»€ä¹ˆï¼‰ï¼Œå¹¶è¡Œæ£€ç´¢æ— æ³•è§£å†³ã€‚è¿™æ—¶ç³»ç»Ÿè¿›å…¥ **IRCoT** æ¨¡å¼ã€‚

### 4.1 çŠ¶æ€æœºè®¾è®¡
`agent_retrieval` å‡½æ•°ï¼ˆä½äº `main.py`ï¼‰ç»´æŠ¤äº†ä¸€ä¸ªåŸºäº LLM çš„çŠ¶æ€æœºå¾ªç¯ã€‚å¾ªç¯çš„é©±åŠ¨åŠ›æ¥è‡ªäº Prompt çš„ç‰¹æ®ŠæŒ‡ä»¤ï¼š

> "If you have enough information... write **'So the answer is:'**..."
> "If you need more information... write **'The new query is:'**..."

### 4.2 åŠ¨æ€ä¸Šä¸‹æ–‡ç´¯ç§¯
åœ¨æ¯ä¸€è½®è¿­ä»£ï¼ˆStepï¼‰ä¸­ï¼Œç³»ç»Ÿæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
1.  **æ„å»ºä¸Šä¸‹æ–‡:** å°†å½“å‰ç´¯ç§¯çš„æ‰€æœ‰ä¸‰å…ƒç»„ï¼ˆTriplesï¼‰å’Œæ–‡æœ¬å—ï¼ˆChunksï¼‰æ‹¼æ¥æˆ Contextã€‚
2.  **LLM å†³ç­–:** LLM é˜…è¯» Context å’Œå†å²æ€ç»´é“¾ï¼ˆThoughtsï¼‰ï¼Œå†³å®šæ˜¯è¾“å‡ºç­”æ¡ˆè¿˜æ˜¯å‘èµ·æ–°æŸ¥è¯¢ã€‚
3.  **åŠ¨æ€æ£€ç´¢:** å¦‚æœå‘èµ·æ–°æŸ¥è¯¢ï¼Œ`KTRetriever` ä¼šé’ˆå¯¹è¿™ä¸ª*æ–°ç”Ÿæˆçš„é—®é¢˜*æ‰§è¡Œæ£€ç´¢ã€‚
4.  **çŸ¥è¯†æ›´æ–°:** æ–°æ£€ç´¢åˆ°çš„çŸ¥è¯†è¢«åˆå¹¶å…¥ `all_triples` å’Œ `all_chunk_ids` é›†åˆä¸­ã€‚

```python
# main.py (Agent Loop)

while step <= max_steps:
    # ... Prompt Construction ...
    response = kt_retriever.generate_answer(ircot_prompt)
    
    if "So the answer is:" in response:
        break # ç»ˆæ­¢æ¡ä»¶
        
    if "The new query is:" in response:
        new_query = ...
        # æ‰§è¡Œæ–°ä¸€è½®æ£€ç´¢ï¼Œæ›´æ–°çŸ¥è¯†åº“
        retrieval_results, _ = kt_retriever.process_retrieval_results(new_query, ...)
        all_triples.update(retrieval_results['triples'])
```

### 4.3 æ½œåœ¨é£é™©åˆ†æ
è¿™ç§ä¸²è¡Œè¿­ä»£æœºåˆ¶è™½ç„¶æ¨ç†èƒ½åŠ›å¼ºå¤§ï¼Œä½†ä¹Ÿå¸¦æ¥äº†ä¸¤ä¸ªæ˜¾è‘—çš„å·¥ç¨‹æŒ‘æˆ˜ï¼š
1.  **å»¶è¿Ÿå åŠ  (Latency Stacking):** æ¯ä¸€è½® Step éƒ½åŒ…å«ä¸€æ¬¡ LLM è°ƒç”¨å’Œä¸€æ¬¡æ£€ç´¢æ“ä½œã€‚å¦‚æœè¿­ä»£ 5 æ¬¡ï¼Œæ€»è€—æ—¶å¯èƒ½æ˜¯å•æ¬¡ RAG çš„ 5-10 å€ã€‚
2.  **ä¸Šä¸‹æ–‡æº¢å‡º (Context Overflow):** éšç€çŸ¥è¯†ä¸æ–­ç´¯ç§¯ (`context += ...`)ï¼ŒPrompt çš„é•¿åº¦å•è°ƒå¢åŠ ã€‚å¦‚æœä¸å¼•å…¥åŠ¨æ€çš„ Token æˆªæ–­æˆ–ç›¸å…³æ€§è¿‡æ»¤æœºåˆ¶ï¼Œå¾ˆå®¹æ˜“åœ¨åæœŸè¿­ä»£ä¸­é€šè¿‡ Token Limit å¯¼è‡´å´©æºƒã€‚

## 5. è½åœ°å›å½’ï¼šChunk å›æº¯ (Graph-to-Text)

è™½ç„¶æ¨ç†è¿‡ç¨‹ä¾èµ–äºå›¾è°±ï¼ˆä¸‰å…ƒç»„ï¼‰ï¼Œä½†æœ€ç»ˆç”Ÿæˆç­”æ¡ˆæ—¶ï¼Œç³»ç»Ÿå¹¶æœªæŠ›å¼ƒåŸå§‹æ–‡æœ¬ã€‚

åœ¨æ£€ç´¢çš„æ¯ä¸€é˜¶æ®µï¼Œç³»ç»Ÿéƒ½ä¼šé€šè¿‡èŠ‚ç‚¹å±æ€§ä¸­çš„ `chunk id` å›æº¯åˆ°åŸå§‹æ–‡æ¡£ç‰‡æ®µï¼Œå¹¶ä½¿ç”¨ `_rerank_chunks_by_relevance` å¯¹è¿™äº›ç‰‡æ®µè¿›è¡Œé‡æ’åºã€‚æœ€ç»ˆæä¾›ç»™ LLM çš„ä¸Šä¸‹æ–‡æ˜¯ **â€œç»“æ„åŒ–éª¨æ¶ï¼ˆå›¾ï¼‰+ éç»“æ„åŒ–è¡€è‚‰ï¼ˆæ–‡æœ¬ï¼‰â€** çš„æ··åˆä½“ã€‚è¿™ç¡®ä¿äº†ç”Ÿæˆçš„ç­”æ¡ˆæ—¢æœ‰é€»è¾‘çš„ä¸¥å¯†æ€§ï¼Œåˆæœ‰åŸæ–‡çš„ç»†èŠ‚ä¸°å¯Œåº¦ã€‚

## 6. æ€»ç»“

`youtu-graphrag` çš„æ¨ç†å±‚å±•ç¤ºäº†ä¸€ä¸ªæˆç†Ÿçš„ Agentic ç³»ç»Ÿé›å½¢ã€‚å®ƒé€šè¿‡ **GraphQ** å®ç°äº†å¤æ‚é—®é¢˜çš„é™ç»´ï¼Œé€šè¿‡ **IRCoT** å®ç°äº†åŠ¨æ€çš„è·¯å¾„è§„åˆ’ã€‚

ä» Schema çš„å®šä¹‰ï¼Œåˆ°å›¾è°±çš„æ„å»ºä¸æ¼”è¿›ï¼Œå†åˆ°å¤šç²’åº¦çš„å­˜å‚¨ä¸ç´¢å¼•ï¼Œæœ€ååˆ° Agent çš„åŠ¨æ€æ¨ç†ï¼Œ`youtu-graphrag` æä¾›äº†ä¸€å¥—å®Œæ•´çš„ã€å‚ç›´ç»Ÿä¸€çš„è§£å†³æ–¹æ¡ˆã€‚
